# Content

* [Content](#content)
* [简介](#简介)
* [流程对比](#流程对比)
* [Mybatis流程](#mybatis流程)
  * [导包](#导包)
  * [全局配置文件](#全局配置文件)
  * [SQL映射文件](#sql映射文件)
  * [全局配置中注册映射文件](#全局配置中注册映射文件)
  * [测试](#测试)
* [HelloWorld示例](#helloworld示例)
  * [TestCase](#testcase)
* [实现细节](#实现细节)
* [全局配置文件](#全局配置文件-1)
  * [properties（*） - 引用外部配置文件](#properties---引用外部配置文件)
  * [settings（*） - 修改mybatis运行时行为](#settings---修改mybatis运行时行为)
  * [typeAliases - 类型别名](#typealiases---类型别名)
  * [typeHandlers - 类型处理器](#typehandlers---类型处理器)
  * [plugins - 插件](#plugins---插件)
  * [environments - 环境配置](#environments---环境配置)
  * [databaseIdProvider - 数据库移植](#databaseidprovider---数据库移植)
  * [mappers（*）- 批量注册](#mappers--批量注册)

# 简介

持久化框架

![](/static/2021-08-04-14-40-38.png)
![](/static/2021-08-04-14-37-27.png)

* jdbc耦合

![](/static/2021-08-04-14-37-01.png)
![](/static/2021-08-04-14-37-10.png)

* hibernate限制复杂sql编写
  * 非要写必须通过HQL
* 全映射框架
  * 部分字段映射很难

mybatis（轻量级框架）

![](/static/2021-08-04-14-43-41.png)
![](/static/2021-08-04-14-48-55.png)

# 流程对比

1.导包

* mybatis
* 数据库驱动
* 日志包（建议）`log4j`
  * 关键环节有log输出
  * 依赖`log4j.xml`配置文件

2.环境搭建

* 原生环境搭建
  * 创建测试库，测试表，以及封装数据的javaBean，操作数据库的DAO
  * ![](/static/2021-08-04-15-06-25.png)
  * ![](/static/2021-08-04-15-06-45.png)
* mybatis环境搭建
  * 导包
  * 写配置
  * 测试

# Mybatis流程

## 导包

![](/static/2021-08-04-15-13-08.png)

## 全局配置文件

指导mybatis如何正确运行，如连接哪个数据库

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
  <environments default="development">
    <environment id="development">
      <transactionManager type="JDBC"/>
      <!-- 连接池 -->
      <dataSource type="POOLED">
        <property name="driver" value="${driver}"/>
        <property name="url" value="${url}"/>
        <property name="username" value="${username}"/>
        <property name="password" value="${password}"/>
      </dataSource>
    </environment>
  </environments>
  <mappers>
    <mapper resource="org/mybatis/example/BlogMapper.xml"/>
  </mappers>
</configuration>
```

## SQL映射文件

编写每个DAO方法如何向数据库发送sql，如何执行

* 本来是给DAO接口写一个实现类，现在用映射文件充当
* **这个映射文件，mybatis默认不知道，需要在全局配置文件中注册**

`#{属性名}`取出传过来的参数

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <!-- namespace：名称空间，接口全类名，告诉mybatis这个配置文件实现哪个接口的 -->
<mapper namespace="org.mybatis.example.BlogMapper">
<!-- 定义查询操作
    id:方法名，相当于对于某个方法的实现
    resultType：方法返回后的返回值类型（全类名）
    #{属性名}取出传过来的参数
 -->
  <select id="selectBlog" resultType="Blog">
    select * from Blog where id = #{id}
  </select>
</mapper>
```

![](/static/2021-08-04-15-06-45.png)
![](/static/2021-08-04-15-34-41.png)

## 全局配置中注册映射文件

![](/static/2021-08-04-15-36-46.png)

## 测试

1.根据全局配置文件，创建一个`SqlSessionFactory`

* 负责创建SqlSession对象
  * sql会话，代表和db的一次会话

```java
String resource = "org/mybatis/example/mybatis-config.xml";
InputStream inputStream = Resources.getResourceAsStream(resource);
SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
```

2.获取和db的一次会话（拿一次连接）

```java
try (SqlSession session = sqlSessionFactory.openSession()) {
//   Blog blog = (Blog) session.selectOne("org.mybatis.example.BlogMapper.selectBlog", 101);
}
```

3.使用SqlSession操作db，获取DAO接口的实现（**映射器mapper**） & 调用接口方法

```java
try (SqlSession session = sqlSessionFactory.openSession()) {
  BlogMapper mapper = session.getMapper(BlogMapper.class);
  Blog blog = mapper.selectBlog(101);
}
```

![](/static/2021-08-04-15-47-23.png)

4.用完释放会话

![](/static/2021-08-04-15-49-41.png)

# HelloWorld示例

DAO接口
![](/static/2021-08-04-16-04-25.png)

全局配置
![](/static/2021-08-04-16-05-07.png)
![](/static/2021-08-04-16-18-14.png)

---

映射文件
![](/static/2021-08-04-16-07-44.png)

* 指定映射哪个DAO接口（哪个DAO接口的实现）

查
![](/static/2021-08-04-16-11-01.png)

改
![](/static/2021-08-04-16-12-31.png)

删
![](/static/2021-08-04-16-13-39.png)

增
![](/static/2021-08-04-16-14-33.png)

## TestCase

![](/static/2021-08-04-16-17-25.png)

查
![](/static/2021-08-04-16-17-48.png)

增
![](/static/2021-08-04-16-21-36.png)
![](/static/2021-08-04-16-22-36.png)

# 实现细节

SqlSession中获取的**映射器**（获取到的是代理对象），相当于DAO的一个实现类，mybatis自动创建的

SqlSessionFactory创建SqlSession对象，Factory本身只用new一次就行

* `SqlSession`，相当于与db进行交互的一次会话，每次会话应该创建一个新的

# 全局配置文件

![](/static/2021-08-04-18-05-41.png)

保证标签先后顺序

## properties（*） - 引用外部配置文件

相当于 spring，context，property-placeholder。引用外部配置文件

* `resource` - 类路径下开始引用
* `url` - 磁盘路径或网络资源

![](/static/2021-08-04-16-35-30.png)

## settings（*） - 修改mybatis运行时行为

属性

* `mapUnderscoreToCamelCase`
  * 是否开启驼峰命名自动映射，即从经典数据库列名 `A_COLUMN` 映射到经典 Java 属性名 `aColumn`

:bulb: bean字段名和db字段名对得上的可以自动映射，不一样但满足上面驼峰命名映射的，开启映射后也可以进行自动映射

![](/static/2021-08-04-16-50-24.png)
![](/static/2021-08-04-16-50-40.png)
![](/static/2021-08-04-16-48-47.png)

## typeAliases - 类型别名

<font color="deeppink">不推荐起别名</font>

为常用的java类型（javabean）起别名

![](/static/2021-08-04-16-56-33.png)

* 之前得写全类名

默认别名（类名
![](/static/2021-08-04-16-57-18.png)
![](/static/2021-08-04-16-57-01.png)

指定别名
![](/static/2021-08-04-16-57-48.png)
![](/static/2021-08-04-16-57-59.png)

---

批量起别名

* 也可以指定一个包名，MyBatis 会在包名下面搜索需要的 Java Bean，比如：

```xml
<typeAliases>
  <package name="domain.blog"/>
</typeAliases>
```

![](/static/2021-08-04-16-59-21.png)

:bulb: 如果想在批量起别名时指定别名，使用`@Alias`注解

```java
@Alias("author")
public class Author {
    ...
}
```

## typeHandlers - 类型处理器

![](/static/2021-08-04-17-42-37.png)

* 填充占位符的时候需要自己判断setStr/int
* mybatis底层一样，通过typeHandler进行判断

可以自定义，实现后加进全局配置文件就可以
![](/static/2021-08-04-17-51-15.png)

## plugins - 插件

![](/static/2021-08-04-17-55-22.png)

## environments - 环境配置

配一个具体环境，每一个都需要事务管理器 & 数据源

* `id` - 当前环境唯一表示
* `default` - 默认使用哪个环境

![](/static/2021-08-04-18-00-02.png)

* :bulb:**之后数据源 & 事务管理器都在spring中配，更强大**

## databaseIdProvider - 数据库移植

一般很少有这个需求

```xml
<databaseIdProvider type="DB_VENDOR">
<!-- name：数据库厂商标识，value：标识名字 -->
  <property name="SQL Server" value="sqlserver"/>
  <property name="DB2" value="db2"/>
  <property name="Oracle" value="oracle" />
</databaseIdProvider>
```

![](/static/2021-08-04-18-25-50.png)
![](/static/2021-08-04-18-25-40.png)

## mappers（*）- 批量注册

写好的sql映射文件需要用mappers注册

* `class`
  * 引用接口全类名
  * **1.需要xml和DAO接口同目录下，且文件名&DAO接口名相同，不然绑定失败** （不太好维护，推荐用`resource`）
    * ![](/static/2021-08-04-18-30-22.png)
  * <font color="deeppink">或者不写配置文件，直接用注解(不推荐单独使用。复杂重要的用配置，简单的用注解）</font>
    * ![](/static/2021-08-04-18-32-32.png)
    * ![](/static/2021-08-04-18-32-17.png)
* `resource`
  * 类路径下找映射文件
* `url`
  * 从磁盘或网络路径引用

:bulb: 批量注册

```xml
<!-- 将包内的映射器接口实现全部注册为映射器 -->
<mappers>
  <package name="org.mybatis.builder"/>
</mappers>
```

![](/static/2021-08-04-18-38-24.png)

* 注意普通DAO还是得和配置文件同目录
  * ![](/static/2021-08-04-18-39-38.png)可以配置文件放在同名包里