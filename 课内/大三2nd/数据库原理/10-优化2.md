# Content

* è¿æ¥é€‰æ‹©æ€§ï¼š**ç¬›å¡å°”ç©ºé—´ï¼ˆæ‰€æœ‰æ‹¼æ¥çš„tuple**ï¼‰ä¸­åŒ¹é…å…ƒç»„çš„åˆ†æ•°ã€‚Join Selectivity: fraction of the matching tuples in Cartesian space
* **JOINåŸºæ•°** join cardinality
  * é¢„æµ‹ä¸€ä¸ªè¿æ¥æŸ¥è¯¢çš„åŒ¹é…å›¾å…ƒçš„æ•°é‡ Challenge 1: predict the number of matching tuples of a join query, i.e., join cardinality
* **å¦‚ä½•å°†é¢„æœŸå‡½æ•°ç”¨å…³äºselect & joiné€‰æ‹©æ€§çš„å‡½æ•°è¡¨ç¤º** express the expected cost of the all strategies as a function of selection selectivity and join selectivity
* Optimization Plans:
  * selection and join queries;
  * 3-way join queries

---

* [Content](#content)
* [ç¬›å¡å°”åŸºæ•°ï¼šCartesian cardinality](#ç¬›å¡å°”åŸºæ•°cartesian-cardinality)
* [JOINé€‰æ‹©æ€§&åŸºæ•°ï¼šJOIN SELECTIVITY & CARDINALITY](#joiné€‰æ‹©æ€§åŸºæ•°join-selectivity--cardinality)
* [JOINé€‰æ‹©æ€§å®šç†ï¼ˆç›´æ¥ç”¨æ¥é¢„æµ‹ï¼‰ï¼šJOIN SELECTIVITY THEOREM](#joiné€‰æ‹©æ€§å®šç†ç›´æ¥ç”¨æ¥é¢„æµ‹join-selectivity-theorem)
* [å¦‚ä½•æ‰§è¡ŒJOINæŸ¥è¯¢](#å¦‚ä½•æ‰§è¡ŒjoinæŸ¥è¯¢)
* [JOINæˆæœ¬ç»†åŒ–ï¼šJOIN COST REFINEMENT](#joinæˆæœ¬ç»†åŒ–join-cost-refinement)
  * [Nested-LOOP JOIN](#nested-loop-join)
  * [Index-based Nested-Loop Join](#index-based-nested-loop-join)
  * [é™„ï¼šCount Distinct Problem](#é™„count-distinct-problem)
  * [Sort-Merge JOIN](#sort-merge-join)
  * [Hash-Join](#hash-join)
* [ä¾‹å­-é€‰æ‹©&JOINé€‰æ‹©æ€§ç»†åŒ–è¡¨ç¤ºæˆæœ¬](#ä¾‹å­-é€‰æ‹©joiné€‰æ‹©æ€§ç»†åŒ–è¡¨ç¤ºæˆæœ¬)
* [å¤šå…³ç³»JOINï¼š3-WAY JOIN OPtimization](#å¤šå…³ç³»join3-way-join-optimization)
* [æ•´ä½“ä¼˜åŒ–ä¾‹å­ï¼šHOLISTIC OPTIMIZATION](#æ•´ä½“ä¼˜åŒ–ä¾‹å­holistic-optimization)

# ç¬›å¡å°”åŸºæ•°ï¼šCartesian cardinality

æ­¤ä¾‹æ²¡æœ‰where clauseï¼Œç¬›å¡å°”åŸºæ•°=æ•´ä¸ªç¬›å¡å°”ç©ºé—´

![](/static/2021-05-03-13-52-33.png)

---

join condition(where clause)

![](/static/2021-05-03-13-57-16.png)

* **join cardinality** = |E â‹ˆ D| = 5 matching tuples
* **join selectivity** = |E â‹ˆ D|/|E Ã— D| = 5/15 = 0.333
  * å³**åœ¨ç¬›å¡å°”ç©ºé—´çš„æ‰€æœ‰å…ƒç»„ä¸­èƒ½é€‰æ‹©åˆ°ä¸€ä¸ªåŒ¹é…å…ƒç»„çš„æ¦‚ç‡**ã€‚ i.e., probability of selecting a matching tuple out of all tuples in the Cartesian space

---

![](/static/2021-05-03-13-58-37.png)

# JOINé€‰æ‹©æ€§&åŸºæ•°ï¼šJOIN SELECTIVITY & CARDINALITY

![](/static/2021-05-03-14-04-22.png)

Join query: `R â‹ˆ S` and Cartesian product: `R Ã— S`

:orange: JOIN selectivity

* åŒ¹é…å…ƒç»„åŸºäº å…³ç³»`R` & `S`ç¬›å¡å°”åŸºæ•°çš„å æ¯” join selectivity (js) is the fraction of the matching tuples between the relations R and S out of the Cartesian cardinality (#of concatenated tuples)
  * `js = |R â‹ˆ S| / |R Ã— S| with 0 â‰¤ js â‰¤1`

:orange: ç¬›å¡å°”åŸºæ•° cartesian cardinality

* `|R Ã— S| = |R|*|S|`

:orange: JOINåŸºæ•° join cardinality

* `jc = js * |R| * |S|`

:candy: æŒ‘æˆ˜1ï¼š**åœ¨ä¸æ‰§è¡ŒJOINæŸ¥è¯¢çš„æƒ…å†µä¸‹é¢„æµ‹JOINåŸºæ•°ï¼ˆjc**ï¼‰ã€‚ Challenge 1: Predict the join cardinality (jc) without executing the join query.

# JOINé€‰æ‹©æ€§å®šç†ï¼ˆç›´æ¥ç”¨æ¥é¢„æµ‹ï¼‰ï¼šJOIN SELECTIVITY THEOREM

![](/static/2021-05-03-14-07-51.png)

Theorem 1.

* ç»™å®šJOINä¸¤å±æ€§çš„å”¯ä¸€å€¼ä¸ªæ•° Given n = NDV(A, R) and m = NDV(B, S):
  * `js = 1/max(n, m)`
  * `jc = js* cartesian cardinality = (|R| * |S|) / max(n, m)`

---

:orange: ä¾‹å­

![](/static/2021-05-03-14-10-31.png)

# å¦‚ä½•æ‰§è¡ŒJOINæŸ¥è¯¢

![](/static/2021-05-03-15-05-07.png)

Relation R and S with bR and bS blocks; R.A = S.B

* Memory: `nB` blocks;
* n = NDV(R.A), m = NDV(S.B)
* ç»“æœé›†å—å› å­ Result block: blocking factor `fRS` matching tuples/block.
* åŒ¹é…å…ƒç»„å¤§å°ï¼ˆmaxï¼‰ = å„å…³ç³»å¤§å°ä¹‹å’Œ Size of matching tuple (r, s) = size of tuple r âˆˆ ğ‘ + size of tuple s âˆˆ S

:orange: é™¤äº†è€ƒè™‘ä»ç£ç›˜ä¸­è¯»å…¥çš„å—æ•°ï¼Œè¿˜è¦åŒ…æ‹¬ä»å†…å­˜ä¸­å†™å›ç£ç›˜çš„ ï¼ˆå¦‚æœå†…å­˜ä¸å¤Ÿï¼Œç„¶åè¿˜æœ‰ä¹‹åå†æ¬¡ä»ç£ç›˜ä¸­è¯»å…¥çš„å—æ•°ï¼‰

![](/static/2021-05-03-15-13-15.png)

* <font color="deeppink">å¦‚ä½•è®¡ç®—è¦å†™å›å¤šå°‘å—ï¼Ÿ</font> --- é¦–å…ˆè®¡ç®— **å¯åŒ¹é…åˆ°çš„å…ƒç»„æ•°ï¼ˆå†…å­˜ä¸­ï¼‰ & ç»“æœé›†å—æ•°ï¼ˆæ€»å…±éœ€è¦å¤„ç†çš„**ï¼‰
  * å¯åŒ¹é…åˆ°çš„å…ƒç»„æ•° - matching tuples: `jc = js * |R| * |S| = (1/max(n, m)) * |R| * |S|`
  * ä¸­é—´ç»“æœé›†å—æ•°(æ€»å…±è¦å¤„ç†çš„ï¼Œè¦å†™å›çš„) - `k = (js * |R| * |S|) / fRS`

# JOINæˆæœ¬ç»†åŒ–ï¼šJOIN COST REFINEMENT

## Nested-LOOP JOIN

åµŒå¥—loop join

![](/static/2021-05-03-15-23-52.png)

* åŸºäºå‰é¢çš„æˆæœ¬ï¼Œ**æœªç»†åŒ–æƒ…å†µï¼ˆæ²¡æœ‰åŒ…å«æœ€åå†™å›ç£ç›˜çš„å—æ•°**ï¼‰
  * Expected Cost: `bD + (ceil(bD/(nB-2)) * bE`
    * å†…å…³ç³»è¦åŠ è½½ chunkæ¬¡ï¼Œï¼Œchunkæ•° = å¤–å…³ç³»å—æ•°/ å†…å­˜ç”¨æ¥è£…chunkçš„å—æ•°ï¼ˆnB-2ï¼‰
* **å†™å›ç£ç›˜çš„å—æ•°**
  * åŒ¹é…çš„å…ƒç»„æ•° - `jc = js * |E| * |D| = (1/max(n, m)) * |E| * |D|`
  * ä¸­é—´ç»“æœé›†å—æ•° - `k = jc/fRS = (js * |E| * |D|) / fRS`
  * Include `k` result-block writes from memory to disk during the execution.

:orange: **ç»†åŒ–åæˆæœ¬=(å†™è¿›æ¥è¿›è¡ŒåŒ¹é…çš„æˆæœ¬+åŒ¹é…ç»“æœå†™å›å»çš„æˆæœ¬)** Refined Expected Cost

* `bD + (ceil(bD/(nB-2)) * bE + (js * |E| * |D| / fRS)`

## Index-based Nested-Loop Join

![](/static/2021-05-03-16-07-36.png)

* **Primary Index** on ordering / key:
* ç»†åŒ–æˆæœ¬
  * `bE + |E| * (xD + 1) + (js * |E| * |D| / fRS)`
  * æˆæœ¬ = é€‰æ‹©æˆæœ¬ï¼ˆå†™å…¥ï¼‰+ JOINæˆæœ¬ï¼ˆåŒ¹é…è¿æ¥æ¡ä»¶ï¼Œè¿™é‡Œå¤„ç†â€œ=â€ï¼Œä¸­é—´ç»“æœå†™å›ï¼‰

---

![](/static/2021-05-03-16-24-58.png)

:orange: æ³¨æ„æ˜¯ **èšç°‡ç´¢å¼•ï¼ˆæ–‡ä»¶é’ˆå¯¹index attræœ‰åº**) cluster index (<font color="red">é€‰æ‹©æˆæœ¬åº”è¯¥æ˜¯ t+è¿ç»­å—æˆæœ¬ï¼Œï¼Œå› æ­¤éœ€è¦çŸ¥é“é’ˆå¯¹æŸ `DNO`ï¼Œåˆ°åº•è¿˜è¦è¯»å¤šå°‘ä¸ªè¿ç»­å—</font>)

* æ³¨æ„ï¼šéœ€è¦**é€‰æ‹©é€‰æ‹©æ€§** selection cardinality
  * å› ä¸ºéœ€è¦æ¯ä¸ªéƒ¨é—¨ï¼Œåˆ°åº•èƒ½æ£€ç´¢åˆ°å¤šå°‘ä¸ªèŒå‘˜ ã€**ä»è€Œè®¡ç®—å‡ºï¼ŒæŸDNOä¸‹èƒ½æ£€ç´¢åˆ°çš„è®°å½•æ•°ï¼Œä¸€å…±éœ€è¦è¯»å–çš„è¿ç»­å—æ•°ï¼Œä¹Ÿå°±æ˜¯ é€‰æ‹©SQLçš„é¢„æµ‹æˆæœ¬**ã€‘
  * `sl(E) = 1/ NDV(DNO)` ï¼ˆå‡è®¾å‡åŒ€åˆ†å¸ƒï¼‰
  * `sE = sl(E) * |E| = 1/ NDV(DNO) * |E|` (é€‰æ‹©åŸºæ•°ï¼Œå†™å…¥çš„å—æ•°å¤§å°)
* **å³ä¸€å…±å†™å…¥**
  * `ceil(sE/ fE)` å—ï¼ŒèŒå·¥
* **åº”ç”¨JOINåï¼Œäº§ç”Ÿä¸­é—´ç»“æœé›†ï¼Œå°†ä¸­é—´ç»“æœé›†å—æ•°å†™å›**
  * `k = (js * |E| * |D|) / fRS `

ç»†åŒ–æ€»æˆæœ¬

* ` bD + |D| * (xE + ceil(sE /fE)) + (js * |E| * |D| / fRS)`
  * `|D| * (xE + ceil(sE /fE))` æ¯ä¸ªéƒ¨é—¨d, B+ä¸ŠæŸ¥è¯¢+è®¿é—®æ‰€éœ€æˆæœ¬ã€‚
    * `ceil(sE /fE))`æ˜¯E.DNOä¸‹ä¸€å…±æœ‰çš„è¿ç»­å—æ•°
* æˆæœ¬ = é€‰æ‹©æˆæœ¬ï¼ˆå†™å…¥ï¼‰ + JOINæˆæœ¬ï¼ˆä¸­é—´ç»“æœé›†å†™å›ï¼‰

---

![](/static/2021-05-03-18-31-09.png)

**äºŒçº§éæ’åºéé”®ç´¢å¼•**

* é€‰æ‹©æˆæœ¬ = t + 1(ä¸€å—åŒ…å«è®°å½•æŒ‡é’ˆçš„å¿«ï¼Œå‡è®¾åªæœ‰ä¸€å—) +å‰©ä¸‹çš„æ‰€æœ‰å—ï¼Œéè¿ç»­ ï¼ˆæœ€åæƒ…å†µä¸‹ï¼Œå‡è®¾å‡åŒ€åˆ†å¸ƒï¼Œé‚£å°±æ˜¯è¦åŠ è½½sä¸ªå—ï¼‰

:orange: ç»†åŒ–æ€»æˆæœ¬

* `bD + |D| * (xE + 1 + sE) + (js * |E| * |D| / fRS)`
  * `xE + 1 + sE` - é€‰æ‹©æˆæœ¬

---

## é™„ï¼šCount Distinct Problem

ç­‰ä»·é‡å†™æ€»æˆæœ¬

![](/static/2021-05-03-18-35-56.png)

* å…³æ³¨ `n, m` ï¼ˆNDVï¼‰
* å› æ­¤éœ€è¦å¿«é€Ÿèƒ½ç®—å‡ºå”¯ä¸€å€¼çš„ç®—æ³•/é¢„æµ‹å™¨ --- count distinct problemã€‚  predictor should identify extremely fast the number of distinct values...

-> åªéœ€è¦å°‘é‡ç»Ÿè®¡ä¿¡æ¯ï¼Œå°±èƒ½é©±åŠ¨ä¼˜åŒ–

## Sort-Merge JOIN

![](/static/2021-05-03-18-36-50.png)

* å‰ææœ‰åº
* ç»†åŒ–æˆæœ¬
  * `bR + bS + (js . |R| .|S| / fRS)`

## Hash-Join

å¹³å‡æƒ…å†µä¸‹ï¼Œéœ€è¦å¤–éƒ¨å“ˆå¸Œï¼ˆå†…å­˜ä¸­æ— æ³•å®¹çº³Mä¸ªæ¡¶ï¼‰

* ç»†åŒ–æˆæœ¬
  * `3 * (bR + bS ) + (js * |R| * |S| / fRS)`

# ä¾‹å­-é€‰æ‹©&JOINé€‰æ‹©æ€§ç»†åŒ–è¡¨ç¤ºæˆæœ¬

![](/static/2021-05-03-19-56-50.png)

joiné€‰æ‹©æ€§ & åŸºæ•°ï¼Œåˆ©ç”¨å®šç†è¡¨ç¤º

* `js = 1/ max(NDV(DNO), NDV(DNUMBER))`
  * `n = NDV(DNO) = 125;`
  * `m = NDV(DNUMBER) = 125`
* `js = 1/max(125,125) = 1/125 = 0.008`
* `jc = js * rE * rD = 10,000 matching tuples`
* ç»“æœé›†å—æ•° ` jc/fRS = 10,000/4 = 2,500 result blocks (write)`

ç”¨å„ä¸ªJOINç­–ç•¥è¡¨ç¤ºæˆæœ¬

![](/static/2021-05-03-20-00-49.png)

* æˆæœ¬ = é€‰æ‹©æˆæœ¬ + JOINæˆæœ¬

# å¤šå…³ç³»JOINï¼š3-WAY JOIN OPtimization

![](/static/2021-05-03-20-28-34.png)

---

1. ANDå·¦åŠè¾¹å…ˆæ‰§è¡Œï¼Œç„¶åå³åŠè¾¹

![](/static/2021-05-03-20-44-54.png)

ANDå·¦åŠè¾¹ï¼Œåˆ†ä¸¤ç§æ‰§è¡Œé¡ºåºï¼Œï¼Œï¼Œæœ€åä¸­é—´ç»“æœé›†ï¼ˆJOINåï¼‰å¤§å°=50æ¡è®°å½• = 25å—

* index based - äº²å±è®°å½•ä¸ç®¡æœ€ååŒ¹ä¸åŒ¹é…ï¼Œéƒ½æ˜¯è¦èŠ±æˆæœ¬çš„ï¼Œï¼Œåªä¸è¿‡åŒ¹é…çš„ä¸Šçš„ï¼Œæœ€åè¢«æ”¾å…¥ç»“æœé›†

![](/static/2021-05-03-21-01-06.png)

* æ³¨æ„è¿æ¥æ¡ä»¶ï¼Œï¼ŒANDï¼Œï¼Œä¸Šä¸€æ­¥çš„ä¸­é—´ç»“æœé›† è¿™ä¸€æ­¥è¦åˆ©ç”¨ä¸Šï¼Œè¿›ä¸€æ­¥è¿‡æ»¤ã€‚ã€‚
  * æ‰€ä»¥ JOINåŸºæ•° = `js * |D| * |ET(ä¸Šä¸€æ­¥ä¸­é—´ç»“æœé›†å¤§å°)|`
* æ³¨æ„ä¸Šä¸€æ­¥çš„ä¸­é—´ç»“æœé›†ï¼Œæ‰§è¡Œä¸‹ä¸€æ­¥çš„æ—¶å€™ä»ç„¶åœ¨ä¸»å­˜é‡Œï¼Œæ‰€ä»¥å¿½ç•¥å†æ¬¡åŠ è½½è¿™äº›å—çš„æˆæœ¬
* **æœ€åç»“æœã€‚å› ä¸ºåªè£…å…¥ä¸€ä¸ªå—ä¸­ï¼Œæ²¡æœ‰å†™å›çš„æ„ä¹‰**

---

2. å…ˆæ‰§è¡ŒANDå³åŠè¾¹ï¼Œ å†æ‰§è¡Œå·¦åŠè¾¹

å·¦åŠè¾¹åˆ†ä¸¤ç§é¡ºåºã€‚ï¼ˆå³è¾¹åªèƒ½é’ˆå¯¹eä½¿ç”¨åˆ«çš„ç´¢å¼•ï¼Œå› ä¸ºè¦åŸºäºä¸­é—´ç»“æœï¼‰

![](/static/2021-05-03-21-47-35.png)
![](/static/2021-05-03-21-47-49.png)

# æ•´ä½“ä¼˜åŒ–ä¾‹å­ï¼šHOLISTIC OPTIMIZATION

optimization over select & join query

![](/static/2021-05-03-23-46-08.png)

æ³¨æ„æ¡ä»¶

* selection condition
* join condition

---

1. å…ˆselectå†join
   1. å¯èƒ½å‡å°‘äº†åŒ¹é…çš„å…ƒç»„æ•°é‡
2. å…ˆjoinå†select
   1. å¯èƒ½ç”Ÿæˆå¾ˆå¤§çš„ç»“æœé›†
3. **æ³¨æ„åˆ†æ¸…æ¥šselectå’Œjoinæˆæœ¬**
   1. æ¯”å¦‚2ï¼Œåé¢åˆ«ç”¨joinçš„å¼å­ç®—ã€‚ã€‚ã€‚

![](/static/2021-05-04-00-15-11.png)
![](/static/2021-05-04-00-16-07.png)

---

![](/static/2021-05-04-00-17-47.png)
![](/static/2021-05-04-00-18-34.png)

---

:orange: **å› æ­¤ï¼Œå°½å¯èƒ½è€ƒè™‘å…ˆç­›é€‰å†join**