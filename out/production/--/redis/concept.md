# Content

* [Content](#content)
* [mysql瓶颈](#mysql瓶颈)
* [为什么用NoSQL](#为什么用nosql)
* [Nosql](#nosql)
* [RDBMS vs NOSQL](#rdbms-vs-nosql)
* [商品信息的存储方案](#商品信息的存储方案)
* [NoSQL数据模型简介](#nosql数据模型简介)
* [聚合模型](#聚合模型)
* [NoSQL数据库的四大分类](#nosql数据库的四大分类)
* [分布式数据库CAP原理](#分布式数据库cap原理)
* [一致性与可用性的决择](#一致性与可用性的决择)
* [BASE](#base)
* [分布式+集群简介](#分布式集群简介)

# mysql瓶颈

![](/static/2021-08-17-15-07-12.png)

* 数据量的总大小一个机器放不下时
* 数据的索引(B+ Tree)一个机器的内存放不下时
* 访问量(读写混合)一个实例不能承受

---

Memcached(缓存)+MySQL+垂直拆分

![](/static/2021-08-17-15-08-13.png)

---

Mysql主从读写分离

![](/static/2021-08-17-15-09-55.png)

---

分表分库+水平拆分+mysql集群

![](/static/2021-08-17-15-11-21.png)

MySQL的扩展性瓶颈

![](/static/2021-08-17-15-13-47.png)

# 为什么用NoSQL

![](/static/2021-08-17-15-15-17.png)

# Nosql

是什么

![](/static/2021-08-17-15-17-20.png)

* 泛指非关系型的数据库
* 这些类型的数据存储不需要固定的模式，无需多余操作就可以横向扩展

作用

* **易扩展**
  * NoSQL数据库种类繁多，但是一个共同的特点都是去掉关系数据库的关系型特性。数据之间无关系，这样就非常容易扩展。也无形之间，在架构的层面上带来了可扩展的能力
* **大数据量高性能**
  * NoSQL数据库都具有非常高的读写性能，尤其在大数据量下，同样表现优秀
    * **这得益于它的无关系性，数据库的结构简单**
  * 一般MySQL使用Query Cache，每次表的更新Cache就失效，是一种大粒度的Cache，在针对web2.0的交互频繁的应用，Cache性能不高
    * **而NoSQL的Cache是记录级的，是一种细粒度的Cache，所以NoSQL在这个层面上来说就要性能高很多了**
* **多样灵活的数据模型**
  * NoSQL无需事先为要存储的数据建立字段，随时可以存储自定义的数据格式
  * 而在关系数据库里，**增删字段**是一件非常麻烦的事情。如果是非常大数据量的表，增加字段简直就是一个噩梦

# RDBMS vs NOSQL

![](/static/2021-08-17-15-21-59.png)

RDBMS

* 高度组织化结构化数据
* 结构化查询语言(SQL)
* 数据和关系都存储在单独的表中
* 数据操纵语言，数据定义语言
* 严格的一致性
* 基础事务

NoSQL

* 代表着不仅仅是SQL
* 没有声明性查询语言
* 没有预定义的模式
* **键-值对存储，列存储，文档存储，图形数据库**
* 最终一致性，而非ACID属性
* 非结构化和不可预知的数据:
* CAP定理
* 高性能，高可用性和可伸缩性

# 商品信息的存储方案

![](/static/2021-08-18-14-21-37.png)

* 为什么去IOE（在IT建设过程中，去除IBM小型机、Oracle数据库及EMC存储设备）

![](/static/2021-08-18-14-27-21.png)

![](/static/2021-08-18-14-27-48.png)

![](/static/2021-08-18-14-27-58.png)

总结大型互联网应用(大数据、高并发、多样数据类型)的难点和解决方案

![](/static/2021-08-18-14-31-53.png)
![](/static/2021-08-18-14-34-21.png)

# NoSQL数据模型简介

以一个电商客户、订单、订购、地址模型来对比关系型数据库和非关系型数据库

传统关系型数据库如何设计

![](/static/2021-08-18-14-39-46.png)

* ER图（1：1、1：N、N：1）主外键等
* 1-N 客户-订单
* 订单明细
* 地址（多
* 支付
* 库存，模型...

NOSQL（聚合模型）如何设计

![](/static/2021-08-18-14-47-06.png)
![](/static/2021-08-18-14-48-11.png)
![](/static/2021-08-18-14-48-44.png)

* **BSON** ()是一种类json的一种二进制形式的存储格式，简称Binary JSON，它和JSON一样，**支持内嵌的文档对象和数组对象**

为什么用聚合模型来处理

* **高并发的操作是不太建议用关联查询的**，互联网公司用冗余数据来避免关联查询
* **分布式事务**是支持不了太多的并发的

# 聚合模型

* **KV**
* **BSON**
* 列族
  * 顾名思义，是按列存储数据的。最大的特点是方便存储结构化和半结构化数据，方便做数据压缩，对针对某一 列或者某几列的查询有非常大的IO优势
  * ![](/static/2021-08-18-14-54-32.png)
* 图形
  * ![](/static/2021-08-18-14-55-14.png)

# NoSQL数据库的四大分类

![](/static/2021-08-18-15-00-25.png)

kv键值

![](/static/2021-08-18-15-01-04.png)

文档型数据库（bson格式比较多）

* CouchDB
* MongoDB
  * MongoDB是一个**基于分布式文件存储的数据库**。由C++语言编写。旨在为WEB应用提供可扩展的高性能数据存储解决方案。
  * MongoDB是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。

列存储数据库

* Cassandra、HBase
* 分布式文件系统

图关系数据库

* 它不是放图形的、放的是关系比如：朋友圈社交网络、广告推荐系统
* 社交网络、推荐系统。专注于构建关系图谱
* Neo4j、InfoGrid

---

四者对比

![](/static/2021-08-18-15-11-00.png)

# 分布式数据库CAP原理

传统的ACID分别是什么

* A (Atomicity) 原子性
* C (Consistency) 一致性
* I (Isolation) 独立性
* D (Durability) 持久性

CAP (3选2，**CAP理论就是说在分布式存储系统中，最多只能实现上面的两点**)

![](/static/2021-08-18-15-17-02.png)

* C:Consistency（强一致性）
  * 很难在高并发情况下保证
* A:Availability（可用性）
  * 某些属性弱一致性
* P:Partition tolerance（分区容错性）
  * **而由于当前的网络硬件肯定会出现延迟丢包等问题，所以分区容忍性是我们必须需要实现的。所以我们只能在一致性和可用性之间进行权衡，没有NoSQL系统能同时保证这三点**
* CA 传统Oracle数据库
* **AP** 大多数网站架构的选择
  * 用Redis保证大多数网站的AP
* **CP** Redis、Mongodb

# 一致性与可用性的决择

对于web2.0网站来说，关系数据库的很多主要特性却往往无用武之地

* 数据库事务一致性需求
  * 很多web实时系统并不要求严格的数据库事务，**对读一致性的要求很低， 有些场合对写一致性要求并不高。允许实现最终一致性**
* 数据库的写实时性和读实时性需求
  * 对关系数据库来说，插入一条数据之后立刻查询，是肯定可以读出来这条数据的，但是对于很多web应用来说，并不要求这么高的实时性，比方说在微博发一条消息之后，过几秒乃至十几秒之后，我的订阅者才看到这条动态是完全可以接受的
* 对复杂的SQL查询，特别是多表关联查询的需求
  * 任何大数据量的web系统，都**非常忌讳多个大表的关联查询**，以及复杂的数据分析类型的报表查询，特别是SNS类型的网站，从需求以及产品设计角 度，就避免了这种情况的产生。往往更多的只是单表的主键查询，以及单表的简单条件分页查询，SQL的功能被极大的弱化了

# BASE

![](/static/2021-08-18-15-32-24.png)

BASE就是为了解决关系数据库强一致性引起的问题而引起的可用性降低而提出的解决方案。

它的思想是通过**让系统放松对某一时刻数据一致性的要求来换取系统整体伸缩性和性能上改观**。为什么这么说呢，缘由就在于大型系统往往由于地域分布和极高性能的要求，不可能采用分布式事务来完成这些指标，要想获得这些指标，我们必须采用另外一种方式来完成，这里BASE就是解决这个问题的办法

# 分布式+集群简介

![](/static/2021-08-18-15-35-00.png)

简单来讲：

* 分布式：不同的多台服务器上面部署**不同**的服务模块（工程），他们之间通过Rpc/Rmi之间通信和调用，对外提供服务和组内协作。
* 集群：不同的多台服务器上面部署**相同**的服务模块，通过分布式调度软件进行统一的调度，对外提供服务和访问。