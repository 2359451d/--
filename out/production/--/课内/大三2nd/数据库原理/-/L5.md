# Heap file

插入高效

* 加载文件最后一个数据块至内存（拷贝进缓冲）
* 插入新记录
* 写回disk

检索低效

* 线性搜索
* `b`个块的文件，平均需要 `b/2`次块访问

删除

* 先检索，加载块至buffer
* 删除buffer中记录
* 写回disk
* **造成块中未使用空间**
  * 考虑每条记录中，使用 `1B`的删除标记 deletion marker
  * 删除每条记录时，`deletion marker=1`
  * **需要周期进行文件重组织，释放未使用空间（被删除记录的）**

# Ordered/Sequential File

文件记录根据1或多个字段（ordering field）物理排序

![](/static/2021-03-29-15-42-16.png)

* 如果ordering field 为键，则保证字段值唯一，又称为 ordering key of the file

允许进行针对块的二分查找

* **范围查询高效**
* **非排序字段的随机访问低效**
  * linear search

:orange: 删除插入成本高

* 因为需要保证记录有序
* **插入新纪录**
  * 找到正确插入位置（根据ordering field）
  * 平均文件一半的记录需要被移动
  * **通常通过使用临时乱序溢出文件(temporary unordered file, overflow/transaction file)来改进**，原有序文件称为 main/master file
    * <font color="deeppink">新纪录直接插入溢出文件尾部，周期性对溢出文件进行排序，重组过程中，并与master file进行合并</font>
    * 先排序溢出文件，在于master file合并，重组过程中，被标记了删除的记录需要被移除
* 删除比插入效率稍微高一点，如果使用删除标记，并周期性重组织文件 less severe if deletion markers and periodic reorganization are used

:orange: 修改

* 取决于
  * 检索条件，是否涉及排序字段
    * 涉及 - 二分查找定位
    * 不涉及 - 线性搜索
  * 是否更新排序字段
    * 否 - 直接修改
    * 是 - 需要先删除旧记录再插入

# Hash file

提供对物理文件记录的快速定位（涉及哈希字段时）

* 通常为单个字段，且为键
* 原理
  * 对hash field应用 `h` 散列函数，获取存储该条记录的物理块地址

## Internal Hashing

![](/static/2021-03-29-16-52-12.png)

* `h`：哈希字段空间->物理地址空间 的映射
* 根据哈希字段的值，将记录映射至**记录数组**的某个索引中， `0~M-1`（数组的索引对应地址）

:orange: 散列冲撞情况可以由链式连接来解决

![](/static/2021-03-29-17-06-43.png)
![](/static/2021-03-29-16-57-16.png)

* 新记录（造成冲撞的），放入记录数组中未使用的溢出位置，将被占用的哈希地址（数组索引）的指针指向这个溢出位置

## Goal of a good hashing function

* 一个好的哈希函数能均匀分配记录，最小化冲撞
* 尽可能最大化占用主桶buckets，减少未使用的空间（不要有过多的溢出记录，即不要有过多冲撞）

## External Hashing for Disk Files

hashing for disk files

![](/static/2021-03-29-17-22-18.png)
![](/static/2021-03-29-17-34-22.png)

* `h(x)` 将**每条记录键值映射至一个相对桶索引**（而不是真实物理块地址）
* 再维护一个哈希表，映射**桶索引->磁盘物理块地址**

:orange: 每个桶存储一定数量的记录，散列冲撞问题减轻

* 注意：桶满时，需要维护溢出记录的链表

:orange: Retrieve

* 随机访问记录（涉及哈希字段），，hash方式组织的文件高效
* 随机访问记录，不涉及哈希字段，效率低
  * 因为hash file本质无序

:orange: Deletion

* 从桶中删除记录
  * 如果桶有溢出链，可以将一个溢出记录移至主桶内，代替被删除的记录
* 从溢出桶中删除记录
  * 直接从链表中移除，注意需要追踪溢出桶中的空位置

:orange: Update

* 取决于
  * 搜索条件（定位特定记录） & 被修改的字段
* 如果检索涉及哈希字段
  * 高效定位记录，否则需要线性搜索
* 如果修改字段不是哈希字段
  * 直接修改记录，并写回相同桶
* 如果修改的字段为哈希字段
  * 修改记录后，可能需要移至其他桶，即**需要删除旧记录，再插入新记录**