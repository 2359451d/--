# JVM

黑马JVMP1-11

## JVM JRE JDK关系

![](/static/2020-07-28-01-11-04.png)

## 学习路线

![](/static/2020-07-28-01-17-32.png)

## JVM内存结构

![](/static/2020-07-28-01-18-04.png)

### 程序计数器PC

> Program Counter Register

#### 作用

![](/static/2020-07-28-01-25-42.png)

* 记住**下一条JVM指令的执行地址**
* 特点
  * **线程私有的**，每个线程都有自己的PC
  * <font color="red">唯一 - 不会存在内存溢出</font>

### 虚拟机栈 JVM Stacks

**线程**运行时需要划分的内存空间

![](/static/2020-07-28-01-34-46.png)

* 一个栈存放多个**栈帧** - 每个stack frame同样对应一次方法调用所需内存【线程实质也是方法的调用】
  * 栈帧存
    * 返回地址
    * 参数
    * 局部变量
* <font color="red">每个线程只有一个<b>活动栈帧(栈顶%esp)</b>，对应当前执行的方法(激活)</font>

#### 问题辨析

垃圾回收是否涉及栈内存？

* 栈方法执行结束会自己释放，垃圾回收负责堆内存中无用对象，因此无关

栈内存分配越大越好？

* `-Xss <size>`指令指定栈空间
* <font color="red">会影响线程数量(方法调用)，一般使用默认</font>

方法内**局部变量**是否线程安全？

<font color="red">多线程同时执行某方法，是否会造成变量混乱？</font>

* ![](/static/2020-07-28-01-43-33.png)
* **如局部变量没有逃离作用域则不会**，因为可以<font color="red">通过每个线程的虚拟机栈帧进行维护</font> -> 可以说，局部变量是线程私有的
* <font color="blue">对象作为参数传入方法时(引用)</font>，可能产生线程安全问题
  * ![](/static/2020-07-28-01-50-34.png)
* 最后在方法内<font color="blue">返回对象(逃离当前方法作用域)，并且可以作为其他方法的传参</font>，也可能产生线程安全问题
  * ![](/static/2020-07-28-01-52-10.png)

方法内**静态变量**是否线程安全？
* <font color="blue">static变量，多线程共享，如不加保护可能造成线程安全问题</font>
